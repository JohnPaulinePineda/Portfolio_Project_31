---
title: "R : Sample Size and Power Calculations for Tests Comparing Means in Clinical Research"
author: "John Pauline Pineda"
date: "May 7, 2023"
output: 
  html_document:
    toc: true
    toc_depth: 3
    theme: readable
    highlight: tango
    css: doc.css
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width=15, fig.height=10)
```

# **1. Table of Contents**
|
| This document presents a non-exhaustive list of sample size and power calculations for clinical research mean comparison tests using various helpful packages in <mark style="background-color: #CCECFF">**R**</mark>. 
|
| Mean comparison tests applied during clinical research refer to trials evaluated in terms of mean responses of some primary study endpoints. The objectives of the intended clinical trials usually include the evaluation of intervention effects, demonstration of therapeutic equivalence or non-inferiority and establishment of superiority. The equations applied in this study (mostly contained in the <mark style="background-color: #CCECFF">**base**</mark> package) attempt to provide calculations for the sample size, critical value and power based on the study objectives and hypotheses of interest. 
|
##  1.1 One-Sample Design (OSD)
|
| [One-Sample Design](https://www.taylorfrancis.com/books/mono/10.1201/9781315183084/sample-size-calculations-clinical-research-shein-chung-chow-jun-shao-hansheng-wang-yuliya-lokhnygina) involves individual numeric response values from sampled subjects. In clinical research, responses could be the difference between matched pairs such as the pre-treatment and post-treatment responses or changes from baseline to endpoint within a treatment group. Responses are assumed to be independent and identically distributed normal random variables with zero mean and a given variance. Parameters needed for the computations are as follows:
|
| **[A]** <span style="color: #FF0000">Mean Response</span> : True mean response value obtained from sampled subjects 
|
| **[B]** <span style="color: #FF0000">Reference</span> : Baseline value for comparison
|
| **[C]** <span style="color: #FF0000">Standard Deviation</span> : Data variability based from literature, pilot studies or preliminary experiments
|
| **[D]** <span style="color: #FF0000">Alpha</span> : Maximum allowed Type I error
|
| **[E]** <span style="color: #FF0000">Beta</span> : Maximum allowed Type II error
|
| **[F]** <span style="color: #FF0000">Testing Margin</span> : 
|      **[F.1]** Minimum margin to establish that the mean response is much better than reference
|      **[F.2]** Minimum margin to establish that the mean response is not much worse as the reference
|      **[F.3]** Minimum margin to establish that the mean response is no better and no worse than the reference
|
| A case scenario was provided as follows to demonstrate sample size computation and power analysis applying the different types of hypotheses:
|
| **[Case Scenario]** A clinical research study is being pursued concerning osteoporosis in post-menopausal women. Osteoporosis and osteopenia (or decreased bone mass) most commonly develop in post-menopausal women. The consequences of osteoporosis are vertebral crush fractures and hip fractures. The diagnosis of osteoporosis is made when vertebral bone density is more than 10% below what is expected for sex, age, height, weight, and race. Usually, bone density is reported in terms of standard deviation (SD) from mean values. The World Health Organization (WHO) defines osteopenia as bone density value greater than one SD below peak bone mass levels in young women and osteoporosis as a value of greater than 2.5 SD below the same measurement scale. In medical practice, most clinicians suggest therapeutic intervention should be begun in patients with osteopenia to prevent progression to osteoporosis.
|
###  1.1.1 Test for Equality (OSD_EQUALITY)
|
| **[Research Question]** Suppose that the mean bone density before the treatment is 1.5 SD. After treatment, the mean value is expected to range from 2.0 to 4.0 SD with increments of 0.2. Given a level of significance of 0.05, evaluate the sample size range to achieve statistical test powers equal to 70%, 80% and 90%.
|
| **[Null Hypothesis]** Post-treatment mean bone density - Post-treatment mean bone density equals 0
|
| **[Alternative Hypothesis]** Post-treatment mean bone density - Post-treatment mean bone density does not equal 0
|
| **[A]** <span style="color: #FF0000">Mean Response</span> : 2.0 to 4.0 SD at 0.20 intervals 
|
| **[B]** <span style="color: #FF0000">Reference</span> : 1.5 SD
|
| **[C]** <span style="color: #FF0000">Standard Deviation</span> : Not explicitly given but already factored into the mean values and will cancel out during computation
|
| **[D]** <span style="color: #FF0000">Alpha</span> : 0.05
|
| **[E]** <span style="color: #FF0000">Beta</span> : 0.30, 0.20 and 0.10 corresponding to 70%, 80% and 90% statistical powers
|
| **[F]** <span style="color: #FF0000">Testing Margin</span> : 0 for the Test of Equality hypothesis
|
```{r section_1.1.1, warning=FALSE, message=FALSE}

##################################
# Loading R libraries
##################################
library(moments)
library(car)
library(multcomp)
library(effects)
library(psych)
library(ggplot2)
library(dplyr)
library(ggpubr)
library(rstatix)
library(ggfortify)
library(trend)

##################################
# Defining a range of possible hypothesized values for mu
##################################
mu_Response=seq(2.0,4.0,0.2)

##################################
# Defining a fixed hypothesized value for mu_0
##################################
mu_Reference=1.5

##################################
# Defining a fixed hypothesized value for the standard deviation
##################################
sd=1

##################################
# Defining a fixed hypothesized value for the Type I error
##################################
alpha=0.05

##################################
# Defining a range of possible hypothesized values for the Type II error
##################################
beta=c(0.30,0.20,0.10)

##################################
# Computing the range of samples sizes based on different levels Type II errors
##################################
beta_1=beta[1]
(n_Beta30=(sd*(qnorm(1-alpha/2)+qnorm(1-beta_1))/(mu_Response-mu_Reference))^2)
ceiling(n_Beta30)
z_Beta30=(mu_Response-mu_Reference)/(sd*sqrt(n_Beta30))
(Power_Beta30=pnorm(z_Beta30-qnorm(1-alpha/2))+pnorm(-z_Beta30-qnorm(1-alpha/2)))

beta_2=beta[2]
(n_Beta20=(sd*(qnorm(1-alpha/2)+qnorm(1-beta_2))/(mu_Response-mu_Reference))^2)
ceiling(n_Beta20)
z_Beta30=(mu_Response-mu_Reference)/(sd*sqrt(n_Beta20))
(Power_Beta30=pnorm(z_Beta30-qnorm(1-alpha/2))+pnorm(-z_Beta30-qnorm(1-alpha/2)))

beta_3=beta[3]
(n_Beta10=(sd*(qnorm(1-alpha/2)+qnorm(1-beta_3))/(mu_Response-mu_Reference))^2)
ceiling(n_Beta10)
z_Beta30=(mu_Response-mu_Reference)/(sd*sqrt(n_Beta10))
(Power_Beta30=pnorm(z_Beta30-qnorm(1-alpha/2))+pnorm(-z_Beta30-qnorm(1-alpha/2)))

OneSampleDesign.Equality <- as.data.frame(cbind(mu_Response,n_Beta30,n_Beta20,n_Beta10))
names(OneSampleDesign.Equality) <- c("Posttreatment.Mean.Bone.Density",
                                 "Power=70%",
                                 "Power=80%",
                                 "Power=90%")

##################################
# Restructuring the data
##################################
OneSampleDesign.Equality.Reshaped <- gather(OneSampleDesign.Equality,
                                            "Power=70%","Power=80%","Power=90%",
                                            key="Power",
                                            value="Sample.Size")
OneSampleDesign.Equality.Reshaped$Label <- rep("OSD_EQUALITY",nrow(OneSampleDesign.Equality.Reshaped))

##################################
# Plotting the sample sizes and power curves
##################################
(OneSampleDesign.Equality.PowerAnalysis <- ggplot(OneSampleDesign.Equality.Reshaped,
                                                      aes(x=Posttreatment.Mean.Bone.Density,
                                                          y=Sample.Size, 
                                                          color=Power)) +
   geom_line(size=1)+
   geom_point(size=4)+
   theme_bw() +
   scale_color_brewer(palette="Paired") +
   scale_x_continuous(name="Hypothesized Post-Treatment Mean Bone Density",
                      limits=c(2,4),
                      breaks=seq(2,4,
                                 by=0.2)) +
  scale_y_continuous(name="Treatment Group Sample Size",
                     limits=c(0,50),
                     breaks=seq(0,50,by=5)) +
  theme(axis.title.x=element_text(color="black",face="bold",size=12),
        legend.position="top",
        legend.key.size = unit(1,"cm"),
        legend.key.height = unit(1,"cm"), 
        legend.key.width = unit(1,"cm"),
        legend.title = element_text(size=12,face="bold"), 
        legend.text = element_text(size=12,face="bold"),
        text=element_text(size=12),
        axis.text.y=element_text(color="black",face="bold",hjust=0.25,size=12),
        axis.text.x=element_text(color="black",face="bold",size=12),
        axis.title.y=element_text(color="black",face="bold",size=12),
        axis.ticks.length=unit(0.25,"cm"),
        plot.title=element_text(color="black",size=14,face="bold",hjust=0.50)) +
  ggtitle("One-Sample Design : Test for Equality"))

```

###  1.1.2 Test for Non-Inferiority (OSD_NON-INFERIORITY)

```{r section_1.1.2, warning=FALSE, message=FALSE}

```

###  1.1.3 Test for Superiority (OSD_SUPERIORITY)

```{r section_1.1.3, warning=FALSE, message=FALSE}

```

###  1.1.4 Test for Equivalence (OSD_EQUIVALENCE)

```{r section_1.1.4, warning=FALSE, message=FALSE}

```

###  1.1.5 Evaluation Summary

```{r section_1.1.5, warning=FALSE, message=FALSE}
##################################
# Consolidating the power analyses charts
##################################

OSD_EQUALITY.PowerAnalysis <- ggplot(OneSampleDesign.Equality.Reshaped,
                                     aes(x=Posttreatment.Mean.Bone.Density,
                                         y=Sample.Size, 
                                         color=Power)) +
   geom_line(size=1)+
   geom_point(size=4)+
   theme_bw() +
   facet_grid(. ~ Label) +
   scale_color_brewer(palette="Paired") +
   scale_x_continuous(name="Hypothesized Post-Treatment Mean Bone Density",
                      limits=c(2,4),
                      breaks=seq(2,4,
                                 by=0.2)) +
  scale_y_continuous(name="Treatment Group Sample Size",
                     limits=c(0,50),
                     breaks=seq(0,50,by=5)) +
  theme(axis.title.x=element_text(color="black",face="bold",size=12),
        legend.position="top",
        legend.key.size = unit(1,"cm"),
        legend.key.height = unit(1,"cm"), 
        legend.key.width = unit(1,"cm"),
        legend.title = element_text(size=12,face="bold"), 
        legend.text = element_text(size=12,face="bold"),
        text=element_text(size=12),
        axis.text.y=element_text(color="black",face="bold",hjust=0.25,size=12),
        axis.text.x=element_text(color="black",face="bold",size=12),
        axis.title.y=element_text(color="black",face="bold",size=12),
        axis.ticks.length=unit(0.25,"cm"),
        plot.title=element_text(color="black",size=14,face="bold",hjust=0.50))

OSD_PowerAnalysis <- ggarrange(OSD_EQUALITY.PowerAnalysis,
                               OSD_EQUALITY.PowerAnalysis,
                               OSD_EQUALITY.PowerAnalysis,
                               OSD_EQUALITY.PowerAnalysis,
                               ncol=2, nrow=2)

annotate_figure(OSD_PowerAnalysis,
                top = text_grob("One-Sample Design Power Analysis by Statistical Hypothesis",
                                color = "black",
                                face = "bold",
                                size = 14))

```

##  1.2 Two-Sample Parallel Design

###  1.2.1 Test for Equality

```{r section_1.2.1, warning=FALSE, message=FALSE}

```

###  1.2.2 Test for Non-Inferiority

```{r section_1.2.2, warning=FALSE, message=FALSE}

```

###  1.2.3 Test for Superiority

```{r section_1.2.3, warning=FALSE, message=FALSE}

```

###  1.2.4 Test for Equivalence

```{r section_1.2.4, warning=FALSE, message=FALSE}

```

##  1.3 Two-Sample Crossover Design

###  1.3.1 Test for Equality

```{r section_1.3.1, warning=FALSE, message=FALSE}

```

###  1.3.2 Test for Non-Inferiority

```{r section_1.3.2, warning=FALSE, message=FALSE}

```

###  1.3.3 Test for Superiority

```{r section_1.3.3, warning=FALSE, message=FALSE}

```

###  1.3.4 Test for Equivalence

```{r section_1.3.4, warning=FALSE, message=FALSE}

```

##  1.4 Multiple-Sample One-Way ANOVA Design

###  1.4.1 Pairwise Comparison

```{r section_1.4.1, warning=FALSE, message=FALSE}

```

###  1.4.2 Simultaneous Comparison

```{r section_1.4.2, warning=FALSE, message=FALSE}

```

##  1.5 Multiple-Sample Williams Design

###  1.5.1 Test for Equality

```{r section_1.5.1, warning=FALSE, message=FALSE}

```

###  1.5.2 Test for Non-Inferiority

```{r section_1.5.2, warning=FALSE, message=FALSE}

```

###  1.5.3 Test for Superiority

```{r section_1.5.3, warning=FALSE, message=FALSE}

```

###  1.5.4 Test for Equivalence

```{r section_1.5.4, warning=FALSE, message=FALSE}

```

# **2. References**
|
| **[Book]** [Sample Size Calculations in Clinical Research](https://www.taylorfrancis.com/books/mono/10.1201/9781315183084/sample-size-calculations-clinical-research-shein-chung-chow-jun-shao-hansheng-wang-yuliya-lokhnygina) by Shein-Chung Chow, Jun Shao, Hansheng Wang and Yuliya Lokhnygina
| **[Book]** [Clinical Trial Data Analysis Using R and SAS](https://www.taylorfrancis.com/books/mono/10.1201/9781315155104/clinical-trial-data-analysis-using-sas-ding-geng-din-chen-karl-peace-pinggao-zhang) by Ding-Geng Chen, Karl Peace and Pinggao Zhang
| **[Book]** [Design and Analysis of Experiments with R](https://www.taylorfrancis.com/books/mono/10.1201/b17883/design-analysis-experiments-john-lawson) by John Lawson
| **[Book]** [Design and Analysis of Experiments](https://link.springer.com/book/10.1007/978-3-319-52250-0) by Angela Dean , Daniel Voss and Danel Draguljić
| **[Book]** [Design and Analysis of Experiments](https://bcs.wiley.com/he-bcs/Books?action=index&bcsId=10790&itemId=1119320933) by Douglas Montgomery
| **[Article]** [Power and Sample Size](https://powerandsamplesize.com/) by HyLown Consulting Team
| **[Article]** [An Introduction to Different Types of Study Design](https://s4be.cochrane.org/blog/2021/04/06/an-introduction-to-different-types-of-study-design/) by Hadi Abbas
| **[Article]** [Case-Control and Cohort Studies: A Brief Overview](https://s4be.cochrane.org/blog/2017/12/06/case-control-and-cohort-studies-overview/) by Saul Crandon
| **[Article]** [Cohort Studies: Prospective and Retrospective Designs](https://s4be.cochrane.org/blog/2019/03/06/cohort-studies-prospective-retrospective-designs/) by Izabel de Oliveira
| **[Article]** [Prevalence vs. Incidence: What is the Difference](https://s4be.cochrane.org/blog/2020/11/06/prevalence-vs-incidence-what-is-the-difference/) by Georgina Ford
| **[Article]** [Randomized Clinical Trial (RCT): Simple Definition, Phases, and Types](https://www.statisticshowto.com/experimental-design/randomized-clinical-trial-rcts/) by Statistics-How-To Team
|
|
|
|